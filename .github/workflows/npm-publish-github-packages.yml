name: éƒ¨ç½²åˆ°æœåŠ¡å™¨

on:
    push:
        branches: ['main']

jobs:
    deploy:
        runs-on: ubuntu-latest
        timeout-minutes: 10 # ç¼©çŸ­è¶…æ—¶æ—¶é—´

        steps:
            - name: æ£€å‡ºä»“åº“ä»£ç 
              uses: actions/checkout@v4

            - name: è®¾ç½® SSH ç¯å¢ƒ
              run: |
                  mkdir -p ~/.ssh
                  chmod 700 ~/.ssh
                  echo "${{ secrets.SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/github_actions_key
                  chmod 600 ~/.ssh/github_actions_key
                  ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

            - name: å®‰è£… Rsync å·¥å…·
              run: sudo apt-get update && sudo apt-get install -y rsync

            - name: åœæ­¢ PM2 æœåŠ¡
              run: |
                  ssh -i ~/.ssh/github_actions_key -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_IP }} <<'EOF'
                  cd /www/wwwroot/egg-blog

                  # å¿«é€Ÿæ£€æµ‹å¹¶åœæ­¢PM2
                  if pm2 list | grep -q "app"; then
                    pm2 stop app >/dev/null 2>&1 || true
                    pm2 delete app >/dev/null 2>&1 || true
                  fi

                  # è½»é‡çº§è¿›ç¨‹æ¸…ç†ï¼ˆé¿å…å¤æ‚çš„pgrepæ“ä½œï¼‰
                  pkill -f "npm start" >/dev/null 2>&1 || true
                  pkill -f "egg-scripts" >/dev/null 2>&1 || true
                  EOF

            - name: è½»é‡çº§æ¸…ç†
              run: |
                  ssh -i ~/.ssh/github_actions_key -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_IP }} <<'EOF'
                  cd /www/wwwroot/egg-blog

                  # åªæ¸…ç†å¿…è¦æ–‡ä»¶ï¼ˆé¿å…findå‘½ä»¤ï¼‰
                  rm -rf app config mock scripts test typings package.json README.md jsconfig.json >/dev/null 2>&1 || true

                  # å¿«é€Ÿæ—¥å¿—æ¸…ç†ï¼ˆåªæ¸…ç†logsç›®å½•ï¼Œä¸å…¨å±€æœç´¢ï¼‰
                  if [ -d "logs" ]; then
                    rm -f logs/*.log >/dev/null 2>&1 || true
                  fi

                  # PM2æ—¥å¿—å¿«é€Ÿæ¸…ç†
                  pm2 flush all >/dev/null 2>&1 || true
                  EOF

            - name: åŒæ­¥æ–‡ä»¶åˆ°æœåŠ¡å™¨
              run: |
                  rsync -qr --delete \
                    --exclude='node_modules/' \
                    --exclude='logs/' \
                    --exclude='*.log' \
                    -e "ssh -i ~/.ssh/github_actions_key -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT }}" \
                    $GITHUB_WORKSPACE/ \
                    ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_IP }}:/www/wwwroot/egg-blog/

            - name: å®‰è£…ä¾èµ–å¹¶å¯åŠ¨æœåŠ¡
              timeout-minutes: 3
              run: |
                  ssh -i ~/.ssh/github_actions_key -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_IP }} <<'EOF'
                  cd /www/wwwroot/egg-blog

                  # æ£€æŸ¥åŸºæœ¬ç¯å¢ƒ
                  if [ ! -f "package.json" ]; then
                    echo "âŒ package.json ä¸å­˜åœ¨"
                    exit 1
                  fi

                  # æ£€æŸ¥å¹¶å®‰è£…ä¾èµ–
                  if [ ! -d "node_modules" ] || [ ! -f "node_modules/.installed" ]; then
                    echo "ğŸ“¦ å®‰è£…/æ›´æ–°ä¾èµ–..."
                    npm install --production --silent >/dev/null 2>&1
                    touch node_modules/.installed
                  else
                    echo "âœ… ä¾èµ–å·²å­˜åœ¨"
                  fi

                  # æ£€æŸ¥å…¥å£æ–‡ä»¶å’Œå¯åŠ¨è„šæœ¬
                  if [ -f "app.js" ]; then
                    ENTRY_SCRIPT="./app.js"
                    echo "ä½¿ç”¨ app.js å¯åŠ¨"
                  elif [ -f "index.js" ]; then
                    ENTRY_SCRIPT="./index.js"
                    echo "ä½¿ç”¨ index.js å¯åŠ¨"
                  else
                    # æ£€æŸ¥ package.json ä¸­çš„å¯åŠ¨è„šæœ¬
                    if grep -q '"start:prod"' package.json 2>/dev/null; then
                      ENTRY_SCRIPT="npm"
                      ENTRY_ARGS="run start:prod"
                      echo "ä½¿ç”¨ npm run start:prod å¯åŠ¨"
                    elif grep -q '"start"' package.json 2>/dev/null; then
                      ENTRY_SCRIPT="npx"
                      ENTRY_ARGS="egg-scripts start"
                      echo "ä½¿ç”¨ egg-scripts ç›´æ¥å¯åŠ¨"
                    else
                      echo "âŒ æœªæ‰¾åˆ°åˆé€‚çš„å¯åŠ¨æ–¹å¼"
                      exit 1
                    fi
                  fi

                  # åˆ›å»ºè½»é‡çº§PM2é…ç½®
                  if [ "$ENTRY_SCRIPT" = "npm" ]; then
                    cat > ecosystem.config.js << 'CONFIG_EOF'
                  module.exports = {
                    apps: [{
                      name: 'app',
                      script: 'npm',
                      args: 'run start:prod',
                      instances: 1,
                      autorestart: false,
                      watch: false,
                      max_memory_restart: '500M',
                      max_restarts: 1,
                      min_uptime: '30s',
                      restart_delay: 5000,
                      env: { NODE_ENV: 'production' }
                    }]
                  };
                  CONFIG_EOF
                  elif [ "$ENTRY_SCRIPT" = "npx" ]; then
                    cat > ecosystem.config.js << 'CONFIG_EOF'
                  module.exports = {
                    apps: [{
                      name: 'app',
                      script: 'npx',
                      args: 'egg-scripts start',
                      instances: 1,
                      autorestart: false,
                      watch: false,
                      max_memory_restart: '500M',
                      max_restarts: 1,
                      min_uptime: '30s',
                      restart_delay: 5000,
                      env: { NODE_ENV: 'production' }
                    }]
                  };
                  CONFIG_EOF
                  else
                    cat > ecosystem.config.js << CONFIG_EOF
                  module.exports = {
                    apps: [{
                      name: 'app',
                      script: '$ENTRY_SCRIPT',
                      instances: 1,
                      autorestart: false,
                      watch: false,
                      max_memory_restart: '500M',
                      max_restarts: 1,
                      min_uptime: '30s',
                      restart_delay: 5000,
                      env: { NODE_ENV: 'production' }
                    }]
                  };
                  CONFIG_EOF
                  fi

                  mkdir -p logs >/dev/null 2>&1

                  # æ™ºèƒ½å¯åŠ¨ï¼ˆä¿ç•™é‡è½½é€»è¾‘ä½†ç®€åŒ–æ£€æµ‹ï¼‰
                  if pm2 list | grep -q "app.*online"; then
                    echo "é‡è½½ç°æœ‰è¿›ç¨‹..."
                    pm2 reload app >/dev/null 2>&1 || pm2 restart app >/dev/null 2>&1
                  else
                    echo "å¯åŠ¨æ–°è¿›ç¨‹..."
                    pm2 start ecosystem.config.js >/dev/null 2>&1
                  fi

                  # å…³é”®å®‰å…¨æ£€æŸ¥ï¼ˆå¢åŠ ç­‰å¾…æ—¶é—´ï¼‰
                  echo "ç­‰å¾…åº”ç”¨å¯åŠ¨..."
                  sleep 15

                  # æ£€æŸ¥å¯åŠ¨çŠ¶æ€
                  PM2_STATUS=$(pm2 list | grep "app" | awk '{print $10}' | head -1)
                  echo "PM2 çŠ¶æ€: $PM2_STATUS"

                  if pm2 list | grep -q "app.*online"; then
                    echo "âœ… PM2å¯åŠ¨æˆåŠŸ"
                    
                    # è½»é‡çº§ç«¯å£æ£€æŸ¥
                    if [ -f "/proc/net/tcp" ] && grep -q ":1B59" /proc/net/tcp 2>/dev/null; then
                      echo "âœ… ç«¯å£7001å·²ç›‘å¬"
                    else
                      echo "âš ï¸ ç«¯å£æœªç›‘å¬ï¼Œæ£€æŸ¥åº”ç”¨æ—¥å¿—..."
                      pm2 logs app --lines 5 2>/dev/null || true
                    fi
                    
                    # å¯ç”¨è‡ªåŠ¨é‡å¯
                    pm2 set app autorestart true >/dev/null 2>&1 || true
                  else
                    echo "âŒ å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹è¯¦ç»†é”™è¯¯:"
                    echo "=== PM2 çŠ¶æ€ ==="
                    pm2 list
                    echo "=== é”™è¯¯æ—¥å¿— ==="
                    pm2 logs app --lines 10 2>/dev/null || true
                    echo "=== æ£€æŸ¥æ–‡ä»¶æƒé™ ==="
                    ls -la package.json
                    echo "=== æ£€æŸ¥ä¾èµ– ==="
                    if [ -d "node_modules" ]; then
                      echo "node_modules å­˜åœ¨"
                    else
                      echo "node_modules ä¸å­˜åœ¨"
                    fi
                    exit 1
                  fi

                  pm2 save >/dev/null 2>&1
                  echo "âœ… éƒ¨ç½²å®Œæˆ"
                  EOF

            - name: éƒ¨ç½²å¤±è´¥æ—¶æ¸…ç†
              if: failure()
              run: |
                  ssh -i ~/.ssh/github_actions_key -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_IP }} <<'EOF' || true
                  cd /www/wwwroot/egg-blog
                  pm2 stop app >/dev/null 2>&1 || true
                  pm2 delete app >/dev/null 2>&1 || true
                  EOF
