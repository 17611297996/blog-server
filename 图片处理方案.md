# ğŸ“Š Blog-Server æ€§èƒ½ä¼˜åŒ–æŒ‡å—

> **è§£å†³ Markdown ä¸­ base64 å›¾ç‰‡å¯¼è‡´çš„å“åº”ç¼“æ…¢é—®é¢˜**

## ğŸš¨ é—®é¢˜æè¿°

å½“ Markdown æ–‡ä»¶ä¸­åŒ…å« base64 ç¼–ç çš„å›¾ç‰‡æ—¶ï¼Œä¼šå‡ºç°ä»¥ä¸‹æ€§èƒ½é—®é¢˜ï¼š

-   **å“åº”ä½“è¿‡å¤§**ï¼šbase64 æ¯”åŸå§‹æ–‡ä»¶å¤§ 33%
-   **ä¼ è¾“ç¼“æ…¢**ï¼šå¤§é‡æ•°æ®ä¼ è¾“å½±å“ç”¨æˆ·ä½“éªŒ
-   **å†…å­˜å ç”¨é«˜**ï¼šæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯å†…å­˜å‹åŠ›
-   **è§£ææ€§èƒ½å·®**ï¼šJSON è§£æå¤§æ–‡ä»¶è€—æ—¶

## ğŸ’¡ è§£å†³æ–¹æ¡ˆæ€»è§ˆ

### 1. ğŸ”§ å›¾ç‰‡æå–å’Œåˆ†ç¦»å­˜å‚¨ï¼ˆæ¨èï¼‰

**è‡ªåŠ¨æå– base64 å›¾ç‰‡å¹¶è½¬æ¢ä¸ºæ–‡ä»¶å¼•ç”¨**

```bash
# æå–æ‰€æœ‰æ–‡ç« ä¸­çš„ base64 å›¾ç‰‡,
npm run extract:images

# é‡æ–°ç”Ÿæˆæ–‡ç« ç´¢å¼•
npm run build:articles

# ä¸€é”®ä¼˜åŒ–ï¼ˆæå–å›¾ç‰‡ + é‡å»ºç´¢å¼•ï¼‰
npm run optimize
```

**å·¥ä½œåŸç†**ï¼š

-   æ‰«ææ‰€æœ‰ `.md` æ–‡ä»¶ä¸­çš„ base64 å›¾ç‰‡
-   å°†å›¾ç‰‡ä¿å­˜åˆ° `content/assets/images/` ç›®å½•
-   æ›¿æ¢ markdown ä¸­çš„ base64 å¼•ç”¨ä¸º URL å¼•ç”¨
-   è‡ªåŠ¨å¤‡ä»½åŸæ–‡ä»¶ï¼ˆ`.backup` åç¼€ï¼‰

### 2. ğŸ›ï¸ æ™ºèƒ½å†…å®¹åŠ è½½

**API ç°åœ¨æ”¯æŒå¤šç§å†…å®¹åŠ è½½æ¨¡å¼**ï¼š

```javascript
// è‡ªåŠ¨æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰- æ™ºèƒ½æ£€æµ‹æ–‡ä»¶å¤§å°å’Œbase64å›¾ç‰‡
GET /api/articles/123?includeContent=auto

// å¼ºåˆ¶åŒ…å«å†…å®¹
GET /api/articles/123?includeContent=true

// ä¸åŒ…å«å†…å®¹ï¼ˆä»…å…ƒæ•°æ®ï¼‰
GET /api/articles/123?includeContent=false

// è‡ªå®šä¹‰æ£€æŸ¥å‚æ•°
GET /api/articles/123?includeContent=auto&maxSize=200&checkBase64=true
```

### 3. ğŸ“¡ ä¸“ç”¨å†…å®¹æ¥å£

**å¯¹äºå¤§æ–‡ä»¶ï¼Œæä¾›ä¸“é—¨çš„å†…å®¹è·å–æ¥å£**ï¼š

```javascript
// è·å–åŸå§‹å†…å®¹ï¼ˆä¸åšä»»ä½•é™åˆ¶ï¼‰
GET / api / articles / 123 / content

// è·å–æ–‡ç« æ€§èƒ½ä¿¡æ¯å’Œå»ºè®®
GET / api / articles / 123 / info
```

### 4. ğŸ–¼ï¸ é™æ€æ–‡ä»¶æœåŠ¡

**æå–åçš„å›¾ç‰‡å¯é€šè¿‡é™æ€æœåŠ¡è®¿é—®**ï¼š

```
http://localhost:7001/content/assets/images/article-name-1-abc123.jpg
```

---

## ğŸ› ï¸ ä½¿ç”¨æ•™ç¨‹

### æ­¥éª¤ 1ï¼šæ£€æŸ¥ç°æœ‰æ–‡ç« 

å…ˆäº†è§£å½“å‰æ–‡ç« çš„æ€§èƒ½çŠ¶å†µï¼š

```bash
# è·å–æ–‡ç« æ€§èƒ½ä¿¡æ¯
curl "http://localhost:7001/api/articles/1/info"
```

**å“åº”ç¤ºä¾‹**ï¼š

```json
{
    "success": true,
    "data": {
        "contentInfo": {
            "fileSizeKB": "156.45",
            "hasBase64Images": true,
            "base64ImageCount": 3,
            "estimatedBase64Size": 524288
        },
        "recommendations": [
            {
                "type": "extract_images",
                "message": "å»ºè®®æå– 3 ä¸ªbase64å›¾ç‰‡ä»¥æå‡æ€§èƒ½",
                "action": "npm run extract:images",
                "estimatedSaving": "çº¦ 512.00KB"
            }
        ],
        "apis": {
            "optimized": "/api/articles/1?includeContent=auto",
            "content": "/api/articles/1/content",
            "noContent": "/api/articles/1?includeContent=false"
        }
    }
}
```

### æ­¥éª¤ 2ï¼šæå– base64 å›¾ç‰‡

```bash
# æå–å›¾ç‰‡å¹¶æ›¿æ¢å¼•ç”¨
npm run extract:images
```

**è¾“å‡ºç¤ºä¾‹**ï¼š

```
ğŸš€ å¼€å§‹æå– base64 å›¾ç‰‡...

ğŸ”„ å¤„ç†: react-hooks-guide.md
âœ… æå–å›¾ç‰‡: react-hooks-guide-1-a1b2c3d4.png (125.67 KB)
âœ… æå–å›¾ç‰‡: react-hooks-guide-2-e5f6g7h8.jpg (234.12 KB)
âœ… å®Œæˆ: react-hooks-guide.md

âœ… base64 å›¾ç‰‡æå–å®Œæˆ!
ğŸ’¡ åŸæ–‡ä»¶å·²å¤‡ä»½ä¸º .backup åç¼€
ğŸ’¡ è¯·è¿è¡Œ npm run build:articles é‡æ–°ç”Ÿæˆç´¢å¼•
```

### æ­¥éª¤ 3ï¼šé‡æ–°ç”Ÿæˆç´¢å¼•

```bash
npm run build:articles
```

### æ­¥éª¤ 4ï¼šéªŒè¯ä¼˜åŒ–æ•ˆæœ

```bash
# æ£€æŸ¥ä¼˜åŒ–åçš„æ–‡ç« 
curl "http://localhost:7001/api/articles/1?includeContent=auto"
```

**ä¼˜åŒ–å‰**ï¼š

```json
{
    "data": {
        "content": "# æ ‡é¢˜\n![å›¾ç‰‡](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==...å¾ˆé•¿çš„base64æ•°æ®...)"
    }
}
```

**ä¼˜åŒ–å**ï¼š

```json
{
    "data": {
        "content": "# æ ‡é¢˜\n![å›¾ç‰‡](/content/assets/images/article-1-abc123.png)"
    }
}
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### ä¼˜åŒ–å‰ vs ä¼˜åŒ–å

| æŒ‡æ ‡     | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„         |
| -------- | ------ | ------ | ------------ |
| å“åº”å¤§å° | 2.5MB  | 15KB   | **99.4%** â†“  |
| ä¼ è¾“æ—¶é—´ | 3.2s   | 0.1s   | **96.9%** â†“  |
| å†…å­˜å ç”¨ | é«˜     | ä½     | **æ˜¾è‘—æ”¹å–„** |
| ç”¨æˆ·ä½“éªŒ | æ…¢     | å¿«     | **å¤§å¹…æå‡** |

### æ–‡ä»¶å¤§å°å»ºè®®

| æ–‡ä»¶å¤§å°      | å»ºè®®å¤„ç†æ–¹å¼         |
| ------------- | -------------------- |
| < 100KB       | ç›´æ¥è¿”å›å†…å®¹         |
| 100KB - 500KB | ä½¿ç”¨ `auto` æ¨¡å¼æ£€æŸ¥ |
| > 500KB       | ä½¿ç”¨ä¸“ç”¨å†…å®¹æ¥å£     |
| åŒ…å« base64   | **å¿…é¡»**æå–å›¾ç‰‡     |

---

## ğŸ”§ API è¯¦ç»†è¯´æ˜

### ä¸»è¦æ–‡ç« æ¥å£

#### 1. æ™ºèƒ½æ–‡ç« è¯¦æƒ… `GET /api/articles/:id`

**æŸ¥è¯¢å‚æ•°**ï¼š

-   `includeContent`: `auto`(é»˜è®¤) | `true` | `false`
-   `checkBase64`: `true`(é»˜è®¤) | `false`
-   `maxSize`: æ–‡ä»¶å¤§å°é™åˆ¶(KB)ï¼Œé»˜è®¤ `500`

**å“åº”æ ¼å¼**ï¼š

```json
{
  "success": true,
  "data": {
    "id": 1,
    "title": "æ–‡ç« æ ‡é¢˜",
    "content": "æ–‡ç« å†…å®¹æˆ–è­¦å‘Šä¿¡æ¯",
    "contentWarning": {
      "type": "base64_images",
      "message": "æ–‡ç« åŒ…å« 2 ä¸ªbase64å›¾ç‰‡ï¼Œå»ºè®®å…ˆæå–å›¾ç‰‡",
      "base64ImageCount": 2,
      "estimatedSize": "456.78KB",
      "recommendedAction": "è¿è¡Œ npm run extract:images æå–å›¾ç‰‡"
    },
    "author": {...},
    "category": {...}
  }
}
```

#### 2. ä¸“ç”¨å†…å®¹æ¥å£ `GET /api/articles/:id/content`

**ç”¨é€”**ï¼šè·å–å®Œæ•´åŸå§‹å†…å®¹ï¼Œæ— ä»»ä½•é™åˆ¶
**é€‚ç”¨**ï¼šå¤§æ–‡ä»¶ã€åŒ…å« base64 å›¾ç‰‡çš„æ–‡ä»¶

#### 3. æ€§èƒ½åˆ†ææ¥å£ `GET /api/articles/:id/info`

**ç”¨é€”**ï¼šåˆ†ææ–‡ç« æ€§èƒ½å¹¶æä¾›ä¼˜åŒ–å»ºè®®

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. å¼€å‘é˜¶æ®µ

```bash
# æ·»åŠ æ–°æ–‡ç« åç«‹å³ä¼˜åŒ–
npm run optimize

# å®šæœŸæ£€æŸ¥æ€§èƒ½
curl "http://localhost:7001/api/articles/{id}/info"
```

### 2. ç”Ÿäº§ç¯å¢ƒ

```bash
# éƒ¨ç½²å‰ä¼˜åŒ–
npm run optimize

# ç›‘æ§å¤§æ–‡ä»¶
# è®¾ç½®å‘Šè­¦ï¼šå“åº”å¤§å° > 500KB
```

### 3. å†…å®¹åˆ›ä½œ

**âŒ é¿å…**ï¼š

```markdown
![å›¾ç‰‡](data:image/png;base64,å¾ˆé•¿çš„base64æ•°æ®...)
```

**âœ… æ¨è**ï¼š

```markdown
![å›¾ç‰‡](/content/assets/images/my-image.png)
```

### 4. å‰ç«¯é›†æˆ

```javascript
// æ™ºèƒ½åŠ è½½
const response = await fetch('/api/articles/123?includeContent=auto')
const data = await response.json()

// æ£€æŸ¥æ˜¯å¦æœ‰å†…å®¹è­¦å‘Š
if (data.data.contentWarning) {
    if (data.data.contentWarning.type === 'large_file') {
        // æ˜¾ç¤º"åŠ è½½å®Œæ•´å†…å®¹"æŒ‰é’®
        loadFullContent('/api/articles/123/content')
    } else if (data.data.contentWarning.type === 'base64_images') {
        // æ˜¾ç¤ºä¼˜åŒ–å»ºè®®
        showOptimizationSuggestion(data.data.contentWarning)
    }
}
```

---

## ğŸ›¡ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### Q1: æå–å›¾ç‰‡åæ–‡ç« æ˜¾ç¤ºå¼‚å¸¸ï¼Ÿ

**A**: æ£€æŸ¥é™æ€æ–‡ä»¶æœåŠ¡æ˜¯å¦æ­£ç¡®é…ç½®ï¼š

```javascript
// config/config.default.js
config.static = {
    prefix: '/content/',
    dir: path.join(appInfo.baseDir, 'content')
    // ...å…¶ä»–é…ç½®
}
```

#### Q2: å›¾ç‰‡æå–å¤±è´¥ï¼Ÿ

**A**: æ£€æŸ¥ç›®å½•æƒé™å’Œç£ç›˜ç©ºé—´ï¼š

```bash
ls -la content/assets/images/
df -h
```

#### Q3: API è¿”å›å†…å®¹ä»ç„¶å¾ˆå¤§ï¼Ÿ

**A**: æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†æ­£ç¡®çš„æŸ¥è¯¢å‚æ•°ï¼š

```bash
# é”™è¯¯ï¼šå¼ºåˆ¶åŒ…å«å†…å®¹
curl "/api/articles/123?includeContent=true"

# æ­£ç¡®ï¼šæ™ºèƒ½æ¨¡å¼
curl "/api/articles/123?includeContent=auto"
```

### æ¢å¤å¤‡ä»½

å¦‚æœéœ€è¦æ¢å¤åŸå§‹æ–‡ä»¶ï¼š

```bash
# æ¢å¤å•ä¸ªæ–‡ä»¶
cp content/articles/frontend/article.md.backup content/articles/frontend/article.md

# æ‰¹é‡æ¢å¤
find content/articles -name "*.backup" -exec sh -c 'cp "$1" "${1%.backup}"' _ {} \;
```

---

åˆ›å»ºå®šæœŸä¼˜åŒ–è„šæœ¬ï¼š

```bash
#!/bin/bash
# auto-optimize.sh

echo "ğŸš€ å¼€å§‹è‡ªåŠ¨ä¼˜åŒ–..."
npm run extract:images
npm run build:articles
echo "âœ… ä¼˜åŒ–å®Œæˆ!"
```

---

## ğŸ‰ æ€»ç»“

```bash
npm run optimize
```

---
